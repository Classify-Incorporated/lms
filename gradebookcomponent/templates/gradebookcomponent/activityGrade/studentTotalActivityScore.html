{% extends 'base.html' %}

{% block title %}
Student Total Scores
{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container">
    <h1>Student Total Scores</h1>
    
    <div class="form-group">
        <label for="subject">Select Subject:</label>
        <select id="subject" class="form-control">
            <!-- Subjects will be dynamically populated here -->
        </select>
    </div>

    <div class="table-responsive">
        <table id="scores-table" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Student Name</th>
                    <th>Prelim</th>
                    <th>Mid Term</th>
                    <th>Semi-Final</th>
                    <th>Final</th>
                    <th>Total Term Weighted Score</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script>
    function fetchScores() {
        const subjectId = $('#subject').val();

        $.ajax({
            url: '/studentTotalScoreApi/',
            data: {
                subject: subjectId || 'all'
            },
            success: function(data) {
                console.log('API Response:', data);
                const scoresTableBody = $('#scores-table tbody');
                scoresTableBody.empty();

                if (data && data.term_data) {
                    data.term_data.forEach(function(studentData) {
                        const studentName = studentData.student;

                        studentData.subjects.forEach(function(subjectData) {
                            const subjectName = subjectData.subject_name;
                            const totalWeightedGrade = subjectData.total_weighted_grade;

                            const studentRow = $('<tr>');
                            studentRow.append(`<td>${subjectName}</td>`);
                            studentRow.append(`<td>${studentName}</td>`);

                            // Initialize term score placeholders
                            let termScores = {
                                'Prelim': 'N/A',
                                'Mid Term': 'N/A',
                                'Semi-Final': 'N/A',
                                'Final': 'N/A'
                            };

                            // Fill in the term scores
                            subjectData.terms.forEach(function(term) {
                                termScores[term.term_name] = `${parseFloat(term.percentage).toFixed(2)}`;
                            });

                            // Add term scores to the row
                            studentRow.append(`<td>${termScores['Prelim']}</td>`);
                            studentRow.append(`<td>${termScores['Mid Term']}</td>`);
                            studentRow.append(`<td>${termScores['Semi-Final']}</td>`);
                            studentRow.append(`<td>${termScores['Final']}</td>`);

                            // Add total weighted grade
                            const grade = calculateGrade(totalWeightedGrade);
                            studentRow.append(`<td>${totalWeightedGrade.toFixed(2)}% (${grade})</td>`);

                            scoresTableBody.append(studentRow);
                        });
                    });
                } else {
                    console.warn('No data found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching the scores: ", error);
            }
        });
    }

    function fetchSubjects() {
        $.ajax({
            url: '/getSubjects/',
            success: function(data) {
                console.log("Subjects Data: ", data); // Debugging line
    
                if (data && data.subjects) {
                    const subjectDropdown = $('#subject');
                    subjectDropdown.empty();
                    subjectDropdown.append('<option value="all">All Subjects</option>');
                    
                    data.subjects.forEach(function(subject) {
                        subjectDropdown.append(`<option value="${subject.id}">${subject.subject_name}</option>`);
                    });
                } else {
                    console.warn('No subjects found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching subjects: ", error);
            }
        });
    }
    

    function calculateGrade(termWeightedScore) {
        if (termWeightedScore >= 97.5) return '1.00 (Excellent)';
        if (termWeightedScore >= 94.5) return '1.25 (Very Good)';
        if (termWeightedScore >= 91.5) return '1.50 (Very Good)';
        if (termWeightedScore >= 88.5) return '1.75 (Very Good)';
        if (termWeightedScore >= 85.5) return '2.00 (Satisfactory)';
        if (termWeightedScore >= 82.5) return '2.25 (Satisfactory)';
        if (termWeightedScore >= 79.5) return '2.50 (Satisfactory)';
        if (termWeightedScore >= 76.5) return '2.75 (Fair)';
        if (termWeightedScore >= 74.5) return '3.00 (Fair)';
        return '5.00 (Failed)';
    }

    $(document).ready(function() {
        // Populate subjects dropdown
        fetchSubjects();

        // Fetch scores when the page loads
        fetchScores();

        // Re-fetch data when subject changes
        $('#subject').change(fetchScores);
    });
</script>

{% endblock %}