{% extends 'base.html' %}
{% block title %}
  Student Grades
{% endblock %}
{% block content %}
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Student Grades</h1>
          </div>
          <!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item">
                <a href="#">Home</a>
              </li>
              <li class="breadcrumb-item active">Student Grades</li>
            </ol>
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div>
      <!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="card">
    <div class="card-body">
        <h1 class="mb-4">Student Grades</h1>

        <!-- Semester and Subject Filters -->
        <form method="get" class="form-inline mb-4">
            <div class="form-group mr-2">
                <label for="semester" class="mr-2">Select Semester:</label>
                <select id="semester" name="semester" class="form-control">
                    <option value="" disabled>Select a Semester</option>
                </select>
            </div>

            <div class="form-group">
                <label for="subject" class="mr-2">Select Subject:</label>
                <select id="subject" name="subject" class="form-control">
                    <option value="all" selected>All Subjects</option>
                </select>
            </div>
        </form>

        <div class="table-responsive">
            <table id="scores-table" class="table table-bordered table-hover">
                <thead>
                    <tr id="term-headers">
                        <th>Subject</th>
                        <th>Student Name</th>
                        <!-- Term headers will be dynamically populated here -->
                        <th>Total Term Weighted Score</th>
                        {% if is_teacher %}
                            <th>
                                Allow View <br>
                                <input type="checkbox" id="checkAll" onclick="toggleAllCheckboxes(this)">
                            </th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
</section>
<!-- /.content -->
</div>

<script>
    const isTeacher = {{ is_teacher|yesno:"true,false" }};
    let semesterId = null;

    function fetchScores() {
        const subjectId = $('#subject').val();
        const apiUrl = '/studentTotalScoreApi/';

        $.ajax({
            url: apiUrl,
            data: {
                subject: subjectId || 'all',
                semester: semesterId || 'current'
            },
            success: function(data) {
                const scoresTableBody = $('#scores-table tbody');
                const termHeaders = $('#term-headers');
                scoresTableBody.empty();

                // Keep Subject, Student Name, and other static headers intact
                termHeaders.find('th').slice(2, -2).remove(); // Clear dynamic headers between the static ones

                if (data && data.student_data) {
                    // Extract and create term headers dynamically based on the first student's subjects
                    const firstStudentSubjects = Object.values(data.student_data)[0];
                    const terms = firstStudentSubjects ? Object.values(firstStudentSubjects)[0].map(term => term.term_name) : [];

                    terms.forEach(term => {
                        termHeaders.find('th:nth-last-child(2)').before(`<th>${term}</th>`);
                    });

                    // Populate the student and subject rows
                    Object.keys(data.student_data).forEach(function(studentId) {
                        const studentSubjects = data.student_data[studentId];
                        Object.keys(studentSubjects).forEach(function(subjectName) {
                            const subjectData = studentSubjects[subjectName];

                            const subjectId = subjectData[0].subject_id;  // Ensure this is where subject_id is being accessed
                            console.log('Subject ID:', subjectId);
                            const studentName = subjectData[0].student_name;

                            const studentRow = $('<tr>');
                            studentRow.append(`<td><a href="/studentTotalScore/${studentId}/${subjectId}/?semester=${semesterId}">${subjectName}</a></td>`);
                            studentRow.append(`<td>${studentName}</td>`);  // Assuming the student name is within data or needs to be looked up separately.

                            // Iterate through the terms for this subject and add scores
                            const termScores = {};
                            terms.forEach(term => {
                                termScores[term] = 'N/A';
                            });

                            subjectData.forEach(function(term) {
                                termScores[term.term_name] = `${parseFloat(term.percentage).toFixed(2)}`;
                            });

                            terms.forEach(term => {
                                studentRow.append(`<td>${termScores[term]}</td>`);
                            });

                            // Add the total weighted grade
                            const totalWeightedGrade = parseFloat(data.student_total_weighted_grade[studentId][subjectName]);
                            studentRow.append(`<td>${totalWeightedGrade.toFixed(2)} (${calculateGrade(totalWeightedGrade)})</td>`);

                            if (isTeacher) {
                                const checkboxForm = `
                                    <td>
                                        <input type="checkbox" class="grade-visibility-checkbox" data-student-id="${studentId}" data-subject-id="${subjectName}" name="can_view_grade" ${subjectData.can_view_grade ? 'checked' : ''} onchange="toggleGradeVisibility(${studentId}, ${subjectName}, this.checked)">
                                    </td>`;
                                studentRow.append(checkboxForm);
                            }

                            scoresTableBody.append(studentRow);
                        });
                    });
                } else {
                    const noDataRow = $('<tr>');
                    noDataRow.append('<td colspan="8" class="text-center">No data found</td>');
                    scoresTableBody.append(noDataRow);
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching the scores: ", error);
            }
        });
    }

    function toggleGradeVisibility(studentId, subjectId, canViewGrade) {
        $.ajax({
            type: 'POST',
            url: `/allowGradeVisibility/${studentId}/`,
            data: {
                'subject_id': subjectId,
                'can_view_grade': canViewGrade,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while toggling grade visibility: ", error);
            }
        });
    }

    function toggleAllCheckboxes(checkAllCheckbox) {
        const checkboxes = document.querySelectorAll('.grade-visibility-checkbox');
        const isChecked = checkAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const studentId = checkbox.getAttribute('data-student-id');
            const subjectId = checkbox.getAttribute('data-subject-id');
            toggleGradeVisibility(studentId, subjectId, isChecked);
        });
    }

    function fetchSubjects() {
        $.ajax({
            url: '/getSubjects/',
            data: {
                semester_id: semesterId
            },
            success: function(data) {
                if (data && data.subjects) {
                    const subjectDropdown = $('#subject');
                    subjectDropdown.empty();
                    subjectDropdown.append('<option value="all">All Subjects</option>');

                    data.subjects.forEach(function(subject) {
                        subjectDropdown.append(`<option value="${subject.id}">${subject.subject_name}</option>`);
                    });

                    fetchScores();
                } else {
                    console.warn('No subjects found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching subjects: ", error);
            }
        });
    }

    function fetchSemesters() {
        $.ajax({
            url: '/getSemesters/',
            success: function(data) {
                if (data && data.semesters) {
                    const semesterDropdown = $('#semester');
                    semesterDropdown.empty();

                    semesterDropdown.append('<option value="" disabled>Select a Semester</option>');

                    data.semesters.forEach(function(semester) {
                        const option = `<option value="${semester.id}" ${semester.is_current_semester ? 'selected' : ''}>${semester.semester_name} - ${semester.school_year}</option>`;
                        semesterDropdown.append(option);
                    });

                    semesterId = data.semesters.find(semester => semester.is_current_semester)?.id || data.semesters[0].id;

                    fetchSubjects();
                } else {
                    console.warn('No semesters found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching semesters: ", error);
            }
        });
    }

    function calculateGrade(termWeightedScore) {
        if (termWeightedScore >= 97.5) return '1.00';
        if (termWeightedScore >= 94.5) return '1.25';
        if (termWeightedScore >= 91.5) return '1.50';
        if (termWeightedScore >= 88.5) return '1.75';
        if (termWeightedScore >= 85.5) return '2.00';
        if (termWeightedScore >= 82.5) return '2.25';
        if (termWeightedScore >= 79.5) return '2.50';
        if (termWeightedScore >= 76.5) return '2.75';
        if (termWeightedScore >= 74.5) return '3.00';
        return '5.00 (Failed)';
    }

    $(document).ready(function() {
        fetchSemesters();

        $('#subject').change(fetchScores);
        $('#semester').change(function () {
            semesterId = $(this).val();
            fetchSubjects();
        });
    });
</script>

{% endblock %}
