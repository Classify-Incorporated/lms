{% extends 'base.html' %}

{% block title %}
Student Grades
{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <h1>Student Grades</h1>

    <div class="form-group">
        <label for="semester">Select Semester:</label>
        <select id="semester" class="form-control">
            <!-- Semesters will be dynamically populated here -->
        </select>
    </div>
    
    <div class="form-group">
        <label for="subject">Select Subject:</label>
        <select id="subject" class="form-control">
            <!-- Subjects will be dynamically populated here -->
        </select>
    </div>

    <div class="table-responsive">
        <table id="scores-table" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Student Name</th>
                    <th>Prelim</th>
                    <th>Mid Term</th>
                    <th>Semi-Final</th>
                    <th>Final</th>
                    <th>Total Term Weighted Score</th>
                    {% if is_teacher %}
                        <th>
                            Allow View <br>
                            <input type="checkbox" id="checkAll" onclick="toggleAllCheckboxes(this)">
                        </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>


<script>
    const isTeacher = {{ is_teacher|yesno:"true,false" }};  // Check if the user is a teacher
    let semesterId = null;

    // Fetch and display student scores based on selected subject and semester
    function fetchScores() {
        const subjectId = $('#subject').val();
        const apiUrl = '/studentTotalScoreApi/'; // Use the unified endpoint
        
        $.ajax({
            url: apiUrl,
            data: {
                subject: subjectId || 'all',
                semester: semesterId || 'current' 
            },
            success: function(data) {
                console.log('API Response:', data);
                const scoresTableBody = $('#scores-table tbody');
                scoresTableBody.empty(); // Clear the table body before adding new data
    
                if (data && data.term_data) {
                    data.term_data.forEach(function(studentData) {
                        const studentName = studentData.student;
    
                        studentData.subjects.forEach(function(subjectData) {
                            const subjectName = subjectData.subject_name;
                            const subjectId = subjectData.subject_id;
                            const totalWeightedGrade = subjectData.total_weighted_grade;
    
                            const studentRow = $('<tr>');
                            studentRow.append(`<td><a href="/studentTotalScore/${studentData.student_id}/${subjectId}/?semester=${semesterId}">${subjectName}</a></td>`);
                            studentRow.append(`<td>${studentName}</td>`);
    
                            // Initialize term score placeholders
                            let termScores = {
                                'Prelim': 'N/A',
                                'Mid Term': 'N/A',
                                'Semi-Final': 'N/A',
                                'Final': 'N/A'
                            };
    
                            // Fill in the term scores
                            subjectData.terms.forEach(function(term) {
                                termScores[term.term_name] = `${parseFloat(term.percentage).toFixed(2)}%`;
                            });
    
                            // Add term scores to the row
                            studentRow.append(`<td>${termScores['Prelim']}</td>`);
                            studentRow.append(`<td>${termScores['Mid Term']}</td>`);
                            studentRow.append(`<td>${termScores['Semi-Final']}</td>`);
                            studentRow.append(`<td>${termScores['Final']}</td>`);
    
                            // Add total weighted grade
                            const grade = calculateGrade(totalWeightedGrade);
                            studentRow.append(`<td>${totalWeightedGrade.toFixed(2)}% (${grade})</td>`);
    
                            // Add the checkbox form for grade visibility if the user is a teacher
                            if (isTeacher) {
                                const checkboxForm = `
                                    <td>
                                        <input type="checkbox" class="grade-visibility-checkbox" data-student-id="${studentData.student_id}" data-subject-id="${subjectId}" name="can_view_grade" ${subjectData.can_view_grade ? 'checked' : ''} onchange="toggleGradeVisibility(${studentData.student_id}, ${subjectId}, this.checked)">
                                    </td>`;
                                studentRow.append(checkboxForm);
                            }
    
                            scoresTableBody.append(studentRow);
                        });
                    });
                } else {
                    const noDataRow = $('<tr>');
                    noDataRow.append('<td colspan="8" class="text-center">No data found</td>');
                    scoresTableBody.append(noDataRow);
                    console.warn('No data found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching the scores: ", error);
            }
        });
    }

    function toggleGradeVisibility(studentId, subjectId, canViewGrade) {
        $.ajax({
            type: 'POST',
            url: `/allowGradeVisibility/${studentId}/`,
            data: {
                'subject_id': subjectId,
                'can_view_grade': canViewGrade,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Grade visibility toggled successfully.');
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while toggling grade visibility: ", error);
            }
        });
    }

    function toggleAllCheckboxes(checkAllCheckbox) {
        const checkboxes = document.querySelectorAll('.grade-visibility-checkbox');
        const isChecked = checkAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const studentId = checkbox.getAttribute('data-student-id');
            const subjectId = checkbox.getAttribute('data-subject-id');
            toggleGradeVisibility(studentId, subjectId, isChecked);
        });
    }

    // Fetch the list of subjects and populate the dropdown
    function fetchSubjects() {
        $.ajax({
            url: '/getSubjects/',
            success: function(data) {
                console.log("Subjects Data: ", data);
    
                if (data && data.subjects) {
                    const subjectDropdown = $('#subject');
                    subjectDropdown.empty(); // Clear any existing options
                    subjectDropdown.append('<option value="all">All Subjects</option>');
                    
                    data.subjects.forEach(function(subject) {
                        subjectDropdown.append(`<option value="${subject.id}">${subject.subject_name}</option>`);
                    });
                } else {
                    console.warn('No subjects found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching subjects: ", error);
            }
        });
    }

    function fetchSemesters() {
        $.ajax({
            url: '/getSemesters/',
            success: function(data) {
                console.log("Semesters Data: ", data);
    
                if (data && data.semesters) {
                    const semesterDropdown = $('#semester');
                    semesterDropdown.empty(); // Clear any existing options

                    // Identify and select the current semester
                    const currentSemester = data.semesters.find(semester => semester.is_current_semester);
                    if (currentSemester) {
                        semesterId = currentSemester.id;
                        semesterDropdown.append(`<option value="${currentSemester.id}">${currentSemester.semester_name} - ${currentSemester.school_year}</option>`);
                    }

                    // Add other semesters
                    data.semesters.forEach(function(semester) {
                        if (semester.id !== semesterId) {
                            semesterDropdown.append(`<option value="${semester.id}">${semester.semester_name} - ${semester.school_year}</option>`);
                        }
                    });

                    fetchScores(); // Fetch scores for the selected semester
                } else {
                    console.warn('No semesters found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching semesters: ", error);
            }
        });
    }

    // Calculate the grade based on the term weighted score
    function calculateGrade(termWeightedScore) {
        if (termWeightedScore >= 97.5) return '1.00 (Excellent)';
        if (termWeightedScore >= 94.5) return '1.25 (Very Good)';
        if (termWeightedScore >= 91.5) return '1.50 (Very Good)';
        if (termWeightedScore >= 88.5) return '1.75 (Very Good)';
        if (termWeightedScore >= 85.5) return '2.00 (Satisfactory)';
        if (termWeightedScore >= 82.5) return '2.25 (Satisfactory)';
        if (termWeightedScore >= 79.5) return '2.50 (Satisfactory)';
        if (termWeightedScore >= 76.5) return '2.75 (Fair)';
        if (termWeightedScore >= 74.5) return '3.00 (Fair)';
        return '5.00 (Failed)';
    }

    // Initialize the page: fetch subjects and scores
    $(document).ready(function() {
        fetchSemesters(); // Populate semesters dropdown
        fetchSubjects(); // Populate subjects dropdown

        // Re-fetch scores when the subject or semester selection changes
        $('#subject').change(fetchScores);
        $('#semester').change(function () {
            const selectedValue = $(this).val();
            semesterId = selectedValue !== 'null' ? selectedValue : 'current';
            fetchScores();
        });
    });
</script>


{% endblock %}