{% extends 'base.html' %}

{% block title %}
Student Grades
{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<h1>Student Grades</h1>

<div class="form-group">
    <label for="semester">Select Semester:</label>
    <select id="semester" class="form-control">
        <option value="" disabled>Select a Semester</option>
        <!-- The semesters will be populated here by JavaScript -->
    </select>
</div>

<div class="form-group">
    <label for="subject">Select Subject:</label>
    <select id="subject" class="form-control">
        <option value="all" selected>All Subjects</option>
    </select>
</div>

<div class="table-responsive">
    <table id="scores-table" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Subject</th>
                <th>Student Name</th>
                <th>Prelim</th>
                <th>Mid Term</th>
                <th>Semi-Final</th>
                <th>Final</th>
                <th>Total Term Weighted Score</th>
                {% if is_teacher %}
                    <th>
                        Allow View <br>
                        <input type="checkbox" id="checkAll" onclick="toggleAllCheckboxes(this)">
                    </th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    const isTeacher = {{ is_teacher|yesno:"true,false" }};
    let semesterId = null;

    function fetchScores() {
        const subjectId = $('#subject').val();
        const apiUrl = '/studentTotalScoreApi/';

        $.ajax({
            url: apiUrl,
            data: {
                subject: subjectId || 'all',
                semester: semesterId || 'current'
            },
            success: function(data) {
                const scoresTableBody = $('#scores-table tbody');
                scoresTableBody.empty();

                if (data && data.term_data) {
                    data.term_data.forEach(function(studentData) {
                        const studentName = studentData.student;

                        studentData.subjects.forEach(function(subjectData) {
                            const subjectName = subjectData.subject_name;
                            const subjectId = subjectData.subject_id;
                            const totalWeightedGrade = subjectData.total_weighted_grade;

                            const studentRow = $('<tr>');
                            studentRow.append(`<td><a href="/studentTotalScore/${studentData.student_id}/${subjectId}/?semester=${semesterId}">${subjectName}</a></td>`);
                            studentRow.append(`<td>${studentName}</td>`);

                            let termScores = {
                                'Prelim': 'N/A',
                                'Mid Term': 'N/A',
                                'Semi-Final': 'N/A',
                                'Final': 'N/A'
                            };

                            subjectData.terms.forEach(function(term) {
                                termScores[term.term_name] = `${parseFloat(term.percentage).toFixed(2)}%`;
                            });

                            studentRow.append(`<td>${termScores['Prelim']}</td>`);
                            studentRow.append(`<td>${termScores['Mid Term']}</td>`);
                            studentRow.append(`<td>${termScores['Semi-Final']}</td>`);
                            studentRow.append(`<td>${termScores['Final']}</td>`);
                            studentRow.append(`<td>${totalWeightedGrade.toFixed(2)}% (${calculateGrade(totalWeightedGrade)})</td>`);

                            if (isTeacher) {
                                const checkboxForm = `
                                    <td>
                                        <input type="checkbox" class="grade-visibility-checkbox" data-student-id="${studentData.student_id}" data-subject-id="${subjectId}" name="can_view_grade" ${subjectData.can_view_grade ? 'checked' : ''} onchange="toggleGradeVisibility(${studentData.student_id}, ${subjectId}, this.checked)">
                                    </td>`;
                                studentRow.append(checkboxForm);
                            }

                            scoresTableBody.append(studentRow);
                        });
                    });
                } else {
                    const noDataRow = $('<tr>');
                    noDataRow.append('<td colspan="8" class="text-center">No data found</td>');
                    scoresTableBody.append(noDataRow);
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching the scores: ", error);
            }
        });
    }

    function toggleGradeVisibility(studentId, subjectId, canViewGrade) {
        $.ajax({
            type: 'POST',
            url: `/allowGradeVisibility/${studentId}/`,
            data: {
                'subject_id': subjectId,
                'can_view_grade': canViewGrade,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Grade visibility toggled successfully.');
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while toggling grade visibility: ", error);
            }
        });
    }

    function toggleAllCheckboxes(checkAllCheckbox) {
        const checkboxes = document.querySelectorAll('.grade-visibility-checkbox');
        const isChecked = checkAllCheckbox.checked;

        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const studentId = checkbox.getAttribute('data-student-id');
            const subjectId = checkbox.getAttribute('data-subject-id');
            toggleGradeVisibility(studentId, subjectId, isChecked);
        });
    }

    function fetchSubjects() {
        $.ajax({
            url: '/getSubjects/',
            data: {
                semester_id: semesterId
            },
            success: function(data) {
                if (data && data.subjects) {
                    const subjectDropdown = $('#subject');
                    subjectDropdown.empty();
                    subjectDropdown.append('<option value="all">All Subjects</option>');

                    data.subjects.forEach(function(subject) {
                        subjectDropdown.append(`<option value="${subject.id}">${subject.subject_name}</option>`);
                    });

                    fetchScores();
                } else {
                    console.warn('No subjects found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching subjects: ", error);
            }
        });
    }

    function fetchSemesters() {
        $.ajax({
            url: '/getSemesters/',
            success: function(data) {
                if (data && data.semesters) {
                    const semesterDropdown = $('#semester');
                    semesterDropdown.empty();

                    semesterDropdown.append('<option value="" disabled>Select a Semester</option>');

                    data.semesters.forEach(function(semester) {
                        const option = `<option value="${semester.id}" ${semester.is_current_semester ? 'selected' : ''}>${semester.semester_name} - ${semester.school_year}</option>`;
                        semesterDropdown.append(option);
                    });

                    // Set semesterId to the current semester or first option
                    semesterId = data.semesters.find(semester => semester.is_current_semester)?.id || data.semesters[0].id;

                    fetchSubjects();
                } else {
                    console.warn('No semesters found or data structure is incorrect.');
                }
            },
            error: function(xhr, status, error) {
                console.error("An error occurred while fetching semesters: ", error);
            }
        });
    }

    function calculateGrade(termWeightedScore) {
        if (termWeightedScore >= 97.5) return '1.00';
        if (termWeightedScore >= 94.5) return '1.25';
        if (termWeightedScore >= 91.5) return '1.50';
        if (termWeightedScore >= 88.5) return '1.75';
        if (termWeightedScore >= 85.5) return '2.00';
        if (termWeightedScore >= 82.5) return '2.25';
        if (termWeightedScore >= 79.5) return '2.50';
        if (termWeightedScore >= 76.5) return '2.75';
        if (termWeightedScore >= 74.5) return '3.00';
        return '5.00 (Failed)';
    }

    $(document).ready(function() {
        fetchSemesters();

        $('#subject').change(fetchScores);
        $('#semester').change(function () {
            semesterId = $(this).val();
            fetchSubjects();
        });
    });
</script>

{% endblock %}
