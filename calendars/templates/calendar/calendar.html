{% extends 'base.html' %}
{% load static %}
{% block title %}
  Calendar
{% endblock %}
{% block content %}
  <h1 class="h3 mb-4 text-gray-800">Calendar</h1>

  <!-- Calendar container -->
  <div id="calendar"></div>

  <style>
    #calendar {
      width: 100%;
      max-width: none;
      margin: 0 auto;
    }
    .fc-event-finished {
      background-color: lightslategray !important;
      color: white !important;
    }
    .fc-event-upcoming {
      background-color: orange !important;
      color: white !important;
    }
    .fc-event-ongoing {
      background-color: green !important;
      color: white !important;
    }
    .fc-event-missed {
      background-color: red !important;
      color: white !important;
    }
    .fc-event-answered {
      background-color: #6c757d !important; /* Secondary color */
      color: white !important;
    }
    .fc .fc-event .fc-event-main {
      outline: none !important;
    }
    .fc-event-dot {
      display: none !important;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');

      fetch('/api/activities/')
        .then((response) => response.json())
        .then((events) => {
          console.log('Events data:', events);

          const now = new Date();

          events = events.map(function (event) {
            const start = new Date(event.start);
            const end = event.end ? new Date(event.end) : null;

            if (end && now > end) {
              event.classNames = ['fc-event-finished'];
              event.clickable = false;
            } else if (start > now) {
              event.classNames = ['fc-event-upcoming'];
              event.clickable = false;
            } else if (start <= now && (!end || now <= end)) {
              if (event.answered) {
                event.classNames = ['fc-event-answered']; // Apply secondary color if answered
                event.clickable = false; // Answered events are not clickable
              } else {
                event.classNames = ['fc-event-ongoing'];
                event.clickable = true; // Ongoing events are clickable
                event.url = `/display_question/${event.id}/`; // Set the URL for ongoing events
              }
            } else if (end && now > end) {
              event.classNames = ['fc-event-missed'];
              event.clickable = false;
            }

            event.allDay = event.allDay === true;

            return event;
          });

          var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            events: events,
            eventTimeFormat: {
              hour: '2-digit',
              minute: '2-digit',
              meridiem: true
            },
            displayEventEnd: true,
            eventClick: function (info) {
              if (info.event.extendedProps.clickable) {
                if (info.event.url) {
                  window.location.href = info.event.url;
                }
              } else {
                info.jsEvent.preventDefault(); // Prevent any action for non-clickable events
              }
            },
            eventContent: function (arg) {
              let timeText = '';
              if (arg.event.allDay) {
                timeText = 'All day';
              } else if (arg.event.start && arg.event.end) {
                timeText = arg.timeText;
              } else {
                timeText = arg.timeText.split(' - ')[0];
              }

              return {
                html: `<div>${timeText} ${arg.event.title}</div>`
              };
            }
          });

          calendar.render();
        })
        .catch((error) => console.error('Error fetching events:', error));
    });
  </script>
{% endblock %}
