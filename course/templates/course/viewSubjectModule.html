{% extends 'base.html' %}
{% load static %}
{% block title %}
  {{ subject.subject_name }}
{% endblock %}
{% block content %}
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <h1>{{ subject.subject_name }}</h1>
        <p>Learn more about {{ subject.subject_name }}.</p>
      </div>
    </div>

    {% if is_teacher %}
      {% now 'Y-m-d' as today_date %}
      {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
        <div class="row">
          <div class="col-12 mb-3">
            <a href="{% url 'add_activity' subject.id %}?semester={{ selected_semester_id }}" class="btn btn-primary">Add Activity</a>
            <a href="{% url 'activityList' subject.id %}" class="btn btn-secondary">Activity List</a>
            <a href="javascript:void(0);" onclick="openParticipationModal('{{ subject.id }}')" class="btn btn-secondary">Add Participation</a>
          </div>
        </div>
      {% endif %}
    {% endif %}

    <div class="row">
      <!-- Sidebar for Activities -->
      <div class="col-md-3">
        <!-- Ongoing Activities -->
        <div class="card mb-3">
          <div class="card-header">Ongoing Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in ongoing_activities %}
              <li class="list-group-item">
                {% if activity.id in answered_activity_ids %}
                  <a href="{% url 'studentActivityView' activity.id %}?semester={{ selected_semester_id }}">
                    {{ activity.activity_name }} (Answered)
                  </a>
                {% else %}
                  <a href="{% url 'display_question' activity.id %}?semester={{ selected_semester_id }}">
                    {{ activity.activity_name }}
                  </a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
        

        <!-- Upcoming Activities -->
        <div class="card mb-3">
          <div class="card-header">Upcoming Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in upcoming_activities %}
              <li class="list-group-item">{{ activity.activity_name }}</li>
            {% endfor %}
          </ul>
        </div>

        <!-- Activities to be Graded -->
        <div class="card mb-3">
          <div class="card-header">Activities to be Graded</div>
          <ul class="list-group list-group-flush">
            {% if is_teacher %}
              {% for activity, count in activities_with_grading_needed %}
                <li class="list-group-item">
                  <a href="{% url 'grade_essays' activity.id %}?semester={{ selected_semester_id }}">{{ activity.activity_name }} - {{ count }} submissions to grade</a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>

        <!-- Finished Activities -->
        <div class="card mb-3">
          <div class="card-header">Finished Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in finished_activities|slice:':2' %}
              <li class="list-group-item">
                <a href="{% if is_student %}
                    {% url 'studentActivityView' activity.id %}
                  {% else %}
                    {% url 'teacherActivityView' activity.id %}
                  {% endif %}">
                  {{ activity.activity_name }}
                </a>
              </li>
            {% endfor %}
            {% if finished_activities|length > 2 %}
              <li class="list-group-item">
                <a href="{% url 'subjectFinishedActivities' subject.id %}?semester={{ selected_semester_id }}">View More</a>
              </li>
            {% endif %}
          </ul>
        </div>

        <!-- Student Roster -->
        <div class="card mb-3">
          <div class="card-header">Student Roster</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <a href="{% url 'subjectStudentList' subject.id %}?semester={{ selected_semester_id }}">View List</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-9">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Modules</span>
                {% if is_teacher %}
                  {% now 'Y-m-d' as today_date %}
                  {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
                    <div>
                      <a href="javascript:void(0);" onclick="openModuleModal('{{ subject.id }}')" class="btn btn-primary ml-auto">Add</a>
                    </div>
                  {% endif %}
                {% endif %}
            </div>
            <ul class="list-group list-group-flush">
                {% for module in modules %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <!-- Check if the module has a URL -->
                    {% if module.url %}
                      <span><a href="{{ module.url }}" target="_blank">{{ module.file_name }}</a></span>
                    {% else %}
                      <span>{{ module.file_name }}</span>
                    {% endif %}
                    <div class="dropdown">
                      <button class="btn btn-white btn-sm no-caret" type="button" id="dropdownMenuButtonModule{{ module.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButtonModule{{ module.id }}">
                          <a class="dropdown-item" href="{% url 'viewModule' module.id %}"><i class="fas fa-eye"></i> View</a>
                          {% if is_teacher %}
                          <a class="dropdown-item" href="{% url 'updateModule' module.id %}"><i class="fas fa-edit"></i> Update</a>
                          <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="if(confirm('Are you sure you want to delete this module?')) { window.location.href='{% url 'deleteModule' module.id %}'; }"><i class="fas fa-trash"></i> Delete</a>
                          {% endif %}
                        </div>
                    </div>
                  </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    </div>

    <div class="text-right mr-3">
      <a href="{% url 'SubjectList' %}" class="btn btn-secondary">Back</a>
    </div>
  </div>

  <!-- Custom Modal for Adding Participation -->
  <div id="participationModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between align-items-center">
      <h5>Select Participation Details</h5>
      <button class="close-btn" id="closeParticipationModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="participationModalBody">
      <!-- The content will be loaded dynamically here -->
    </div>
  </div>
  <div id="participationModalBackdrop" class="custom-modal-backdrop"></div>

  <!-- Custom Modal for Adding Module -->
  <div id="moduleModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between align-items-center">
      <h5>Add Module</h5>
      <button class="close-btn" id="closeModuleModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="moduleModalBody">
      <!-- The content will be loaded dynamically here -->
    </div>
  </div>
  <div id="moduleModalBackdrop" class="custom-modal-backdrop"></div>
  

  <script>
    // Function to open the Participation modal and load the content dynamically
    function openParticipationModal(subjectId) {
      fetch(`/selectParticipation/${subjectId}/`)
        .then((response) => response.text())
        .then((html) => {
          document.getElementById('participationModalBody').innerHTML = html
          document.getElementById('participationModal').classList.add('show')
          document.getElementById('participationModalBackdrop').classList.add('show')
        })
    }
    
    // Function to open the Module modal and load the content dynamically
    function openModuleModal(subjectId) {
      fetch(`/createModule/${subjectId}/`)
        .then((response) => response.text())
        .then((html) => {
          document.getElementById('moduleModalBody').innerHTML = html
          document.getElementById('moduleModal').classList.add('show')
          document.getElementById('moduleModalBackdrop').classList.add('show')
        })
    }

    // Script to close the Participation modal
    document.getElementById('closeParticipationModalBtn').addEventListener('click', function () {
      document.getElementById('participationModal').classList.remove('show')
      document.getElementById('participationModalBackdrop').classList.remove('show')
    })
    
    // Script to close the Module modal
    document.getElementById('closeModuleModalBtn').addEventListener('click', function () {
      document.getElementById('moduleModal').classList.remove('show')
      document.getElementById('moduleModalBackdrop').classList.remove('show')
    })
  </script>
{% endblock %}
