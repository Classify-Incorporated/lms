{% extends 'base.html' %}
{% load static %}
{% block title %}
  {{ subject.subject_name }}
{% endblock %}
{% block content %}
  <div class="container-fluid">
    <div class="row justify-content-center mb-4">
      <div class="col-md-12">
        <h3 class="text-primary">{{ subject.subject_name }}</h3>
        <p class="text-muted">Explore activities, lessons, and more for {{ subject.subject_name }}.</p>
      </div>
    </div>

    {% if is_teacher %}
      {% now 'Y-m-d' as today_date %}
      {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
        <div class="row justify-content-center mb-4">
          <div class="col-md-12 justify-content-between">
            <a href="{% url 'add_activity' subject.id %}?semester={{ selected_semester_id }}" class="btn btn-primary">Add Activity</a>
            <a href="{% url 'activityList' subject.id %}" class="btn btn-secondary">Activity List</a>
          </div>
        </div>
      {% endif %}
    {% endif %}

    <div class="row">
      <!-- Sidebar for Activities -->
      <div class="col-md-4">
        <!-- Ongoing Activities -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">Ongoing Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in ongoing_activities %}
              <li class="list-group-item">
                {% if activity.id in answered_activity_ids %}
                  <a href="{% url 'studentActivityView' activity.id %}?semester={{ selected_semester_id }}" class="btn btn-outline-success btn-block">{{ activity.activity_name }} (Answered)</a>
                {% else %}
                  <a href="{% url 'display_question' activity.id %}?semester={{ selected_semester_id }}" class="btn btn-outline-warning btn-block">{{ activity.activity_name }}</a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Upcoming Activities -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-info text-white">Upcoming Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in upcoming_activities %}
              <li class="list-group-item">
                <button class="btn btn-outline-info btn-block">{{ activity.activity_name }}</button>
              </li>
            {% endfor %}
          </ul>
        </div>

        {% if is_teacher %}
          <!-- Activities to be Graded -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-white">Activities to be Graded</div>
            <ul class="list-group list-group-flush">
              {% for activity, count in activities_with_grading_needed %}
                <li class="list-group-item">
                  <a href="{% url 'grade_essays' activity.id %}?semester={{ selected_semester_id }}" class="btn btn-outline-danger btn-block">{{ activity.activity_name }} - {{ count }} submissions to grade</a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <!-- Finished Activities -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-secondary text-white">Finished Activities</div>
          <ul class="list-group list-group-flush">
            {% for activity in finished_activities|slice:':2' %}
              <li class="list-group-item">
                <a href="{% if is_student %}
                    {% url 'studentActivityView' activity.id %}
                  {% else %}
                    {% url 'teacherActivityView' activity.id %}
                  {% endif %}"
                  class="btn btn-outline-secondary btn-block">
                  {{ activity.activity_name }}
                </a>
              </li>
            {% endfor %}
            {% if finished_activities|length > 2 %}
              <li class="list-group-item text-center">
                <a href="{% url 'subjectFinishedActivities' subject.id %}?semester={{ selected_semester_id }}" class="btn btn-outline-primary">View More</a>
              </li>
            {% endif %}
          </ul>
        </div>

        <!-- Student Roster -->
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">Student Roster</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item text-center">
              <a href="{% url 'subjectStudentList' subject.id %}?semester={{ selected_semester_id }}" class="btn btn-outline-primary">View List</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-8">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white d-flex justify-content-between">
            <span>Lessons</span>
            {% if is_teacher %}
              {% if selected_semester.start_date|date:'Y-m-d' <= today_date and selected_semester.end_date|date:'Y-m-d' >= today_date %}
                <button class="btn btn-success" onclick="openModuleModal('{{ subject.id }}')">Add Lesson</button>
              {% endif %}
            {% endif %}
          </div>
          <ul class="list-group list-group-flush">
            {% for module in modules|dictsortreversed:'id' %}
              <li class="list-group-item d-flex justify-content-between">
                {% if module.url %}
                  <a href="{{ module.url }}" target="_blank">{{ module.file_name }}</a>
                {% else %}
                  <span>{{ module.file_name }}</span>
                {% endif %}
                <div class="dropdown">
                  <button class="btn btn-link" type="button" id="dropdownMenuButtonModule{{ module.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                  <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="{% url 'viewModule' module.id %}">View</a>
                    {% if is_teacher %}
                      <a class="dropdown-item" href="{% url 'updateModule' module.id %}">Update</a>
                      <a class="dropdown-item text-danger" href="javascript:void(0);" onclick="if(confirm('Are you sure?')) window.location.href='{% url 'deleteModule' module.id %}';">Delete</a>
                    {% endif %}
                    {% if module.allow_download %}
                      <a class="dropdown-item" href="{% url 'download' module.id %}">Download</a>
                    {% endif %}
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <div class="text-left mt-3">
      <a href="{% url 'SubjectList' %}" class="btn btn-secondary">Back</a>
    </div>
  </div>

  <!-- Custom Modal for Adding Participation -->
  <div id="participationModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5>Select Participation Details</h5>
      <button class="close-btn" id="closeParticipationModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="participationModalBody"></div>
  </div>
  <div id="participationModalBackdrop" class="custom-modal-backdrop"></div>

  <!-- Custom Modal for Adding Module -->
  <div id="moduleModal" class="custom-modal">
    <div class="custom-modal-header d-flex justify-content-between">
      <h5 class="text-dark">Add Lesson</h5>

      <button class="close-btn" id="closeModuleModalBtn"></button>
    </div>
    <div class="custom-modal-body" id="moduleModalBody"></div>
  </div>
  <div id="moduleModalBackdrop" class="custom-modal-backdrop"></div>

  <script>
    function openParticipationModal(subjectId) {
      fetch(`/participationScoresView/${subjectId}/`)
        .then((response) => response.text())
        .then((html) => {
          document.getElementById('participationModalBody').innerHTML = html
          document.getElementById('participationModal').classList.add('show')
          document.getElementById('participationModalBackdrop').classList.add('show')
        })
    }
    
    function openModuleModal(subjectId) {
      fetch(`/createModule/${subjectId}/`)
        .then((response) => response.text())
        .then((html) => {
          document.getElementById('moduleModalBody').innerHTML = html
          document.getElementById('moduleModal').classList.add('show')
          document.getElementById('moduleModalBackdrop').classList.add('show')
    
          // Initialize or refresh selectpicker after loading the modal content
          $('.selectpicker').selectpicker('refresh')
    
          // Add file input label update functionality after the modal content loads
          document.querySelector('.custom-file-input').addEventListener('change', function (e) {
            var fileName = e.target.files[0].name
            e.target.nextElementSibling.innerText = fileName // Update the label with the file name
          })
        })
    }
    
    document.getElementById('closeParticipationModalBtn').addEventListener('click', function () {
      document.getElementById('participationModal').classList.remove('show')
      document.getElementById('participationModalBackdrop').classList.remove('show')
    })
    
    document.getElementById('closeModuleModalBtn').addEventListener('click', function () {
      document.getElementById('moduleModal').classList.remove('show')
      document.getElementById('moduleModalBackdrop').classList.remove('show')
    })
  </script>
{% endblock %}
