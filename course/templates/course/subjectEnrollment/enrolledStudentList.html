{% extends 'base.html' %}

{% block title %}
  Enrolled Students by Subject
{% endblock %}

{% block content %}
  <div class="container my-4">
    <h1 class="mb-4">Enrolled Students by Subject</h1>

    {% if user.profile.role.name.lower != 'teacher' and user.profile.role.name.lower != 'student' %}
      <a href="{% url 'enrollStudent' %}" class="btn btn-primary mb-4">Enroll Student</a>
    {% endif %}

    <!-- Semester and Subject Filters -->
    <form method="get" class="form-inline mb-4">
      <div class="form-group mr-3">
        <label for="semester" class="mr-2">Select Semester:</label>
        <select id="semester" name="semester" class="form-control" onchange="this.form.submit()">
          <option value="">All Semesters</option>
          {% for semester in semesters %}
            <option value="{{ semester.id }}" {% if selected_semester and selected_semester.id == semester.id %}selected{% endif %}>
              {{ semester.semester_name }} - {{ semester.school_year }}
            </option>
          {% endfor %}
        </select>
      </div>
  
      <!-- Subject Filter -->
      <div class="form-group">
        <label for="subject" class="mr-2">Select Subject:</label>
        <select id="subject" name="subject" class="form-control" onchange="this.form.submit()">
          <option value="">All Subjects</option>
          {% for subject in available_subjects %}
            <option value="{{ subject.id }}" {% if selected_subject and selected_subject.id == subject.id %}selected{% endif %}>
              {{ subject.subject_name }}
            </option>
          {% endfor %}
        </select>
      </div>
    </form>

    <!-- Bootstrap Accordion for Subjects -->
    <div class="accordion" id="subjectsAccordion">
      {% for subject, enrollments in subjects.items %}
        <div class="card">
          <div class="card-header" id="heading{{ forloop.counter }}">
            <h5 class="mb-0">
              <button class="btn btn-link text-light bg-primary" style='width:30%' type="button" data-toggle="collapse" data-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ forloop.counter }}">
                {{ subject.subject_name }}
              </button>
            </h5>
          </div>

          <div id="collapse{{ forloop.counter }}" class="collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-parent="#subjectsAccordion">
            <div class="card-body">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Student Name</th>
                    <th scope="col">Semester</th>
                    <th scope="col">Enrollment Date</th>
                    {% if user.profile.role.name.lower != 'teacher' and user.profile.role.name.lower != 'student' %}
                    <th scope="col">Actions</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for enrollment in enrollments %}
                    <tr>
                      <th scope="row">{{ forloop.counter }}</th>
                      <td>{{ enrollment.student.get_full_name }}</td>
                      <td>{{ enrollment.semester.semester_name }} - {{ enrollment.semester.school_year }}</td>
                      <td>{{ enrollment.enrollment_date }}</td>
                      {% if user.profile.role.name.lower != 'teacher' and user.profile.role.name.lower != 'student' %}
                      <td>
                        <a href="{% url 'dropStudentFromSubject' enrollment.id %}" class="btn btn-primary btn-sm"
                          onclick="return confirm('Are you sure you want to drop {{ enrollment.student.get_full_name }} from {{ enrollment.subject.subject_name }}?');">
                          Dropped
                        </a>
                      </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}
