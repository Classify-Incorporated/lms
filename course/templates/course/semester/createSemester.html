<div id="customModal" class="custom-modal">
  <div class="custom-modal-header">
    <button class="close-btn" id="closeModalBtn"></button>
    <h5>Add Semester</h5>
  </div>
  <div class="custom-modal-body">
    <form method="post" action="{% url 'createSemester' %}" class="needs-validation" novalidate>
      {% csrf_token %}

      <!-- Semester Name -->
      <div class="form-group">
        <label for="id_semester_name">Semester Name</label>
        {{ form.semester_name }}
        <div class="invalid-feedback">Please provide a valid semester name.</div>
        {% if form.semester_name.errors %}
          <div class="text-danger">{{ form.semester_name.errors }}</div>
        {% endif %}
      </div>

      <!-- Start Date -->
      <div class="form-group">
        <label for="id_start_date">Start Date</label>
        {{ form.start_date }}
        <div class="invalid-feedback">Please provide a valid start date.</div>
        {% if form.start_date.errors %}
          <div class="text-danger">{{ form.start_date.errors }}</div>
        {% endif %}
      </div>

      <!-- End Date -->
      <div class="form-group">
        <label for="id_end_date">End Date</label>
        {{ form.end_date }}
        <div class="invalid-feedback">Please provide a valid end date.</div>
        {% if form.end_date.errors %}
          <div class="text-danger">{{ form.end_date.errors }}</div>
        {% endif %}
      </div>

      <!-- School Year -->
      <div class="form-group">
        <label for="id_school_year">School Year</label>
        {{ form.school_year }}
        <div class="invalid-feedback">Please provide a valid school year.</div>
        {% if form.school_year.errors %}
          <div class="text-danger">{{ form.school_year.errors }}</div>
        {% endif %}
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
  </div>
</div>

<!-- Custom Modal Backdrop -->
<div id="customModalBackdrop" class="custom-modal-backdrop"></div>

<!-- Flatpickr Library for Date Picking -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const disabledDates = {{ disabled_dates|safe }};  // List of unavailable start and end date tuples from backend

    // Prepare disabled ranges for Flatpickr
    const disableDateRanges = disabledDates.map(function(dates) {
        const [start, end] = dates;
        return { from: new Date(start), to: new Date(end) };
    });

    // Initialize Flatpickr for start date
    const startDatePicker = flatpickr("#id_start_date", {
        minDate: "today",  // Prevent past dates
        disable: disableDateRanges,  // Disable unavailable date ranges
        onChange: function(selectedDates, dateStr, instance) {
            const startDate = selectedDates[0];  // Get the selected start date

            // Check if the end date Flatpickr exists and reinitialize it to avoid any issues
            if (endDatePicker) {
                endDatePicker.destroy();  // Destroy the existing instance
            }

            // Reinitialize Flatpickr for the end date input with new `minDate`
            endDatePicker = flatpickr("#id_end_date", {
                minDate: startDate,  // Set minDate dynamically based on selected start date
                disable: disableDateRanges,  // Disable unavailable date ranges
                defaultDate: startDate,  // Optional: Set the default date for end date to start date for clarity
            });
        }
    });

    // Initialize Flatpickr for end date (initial state)
    let endDatePicker = flatpickr("#id_end_date", {
        disable: disableDateRanges,  // Disable unavailable date ranges
        minDate: "today"  // Initially prevent past dates for end date
    });
});
</script>
