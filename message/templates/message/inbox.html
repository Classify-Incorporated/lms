{% extends 'base.html' %}
{% load static %}
{% block title %}
  Inbox
{% endblock %}
{% block content %}
  <h1>Inbox</h1>
  <button class="btn btn-primary" id="openSendMessageModalBtn">Send Message</button>
  <br><br>
  <p>You have {{ unread_messages_count }} unread messages.</p>
  <div class="row">
    {% for item in message_status_list %}
      <div class="col-md-4 d-flex align-items-stretch">
        <a href="#" class="card mb-3 w-100 text-decoration-none text-dark viewMessageLink" data-id="{{ item.message.id }}">
          <div class="card-body d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">{{ item.message.subject }}</h5>
            <span class="badge {% if item.read %}
                badge-success
              {% else %}
                badge-warning
              {% endif %} ml-auto">
              {% if item.read %}
                Read
              {% else %}
                Unread
              {% endif %}
            </span>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>

  <!-- Include the modals -->
  {% include 'message/message.html' %}

  <!-- View Message Modal -->
  <div id="viewMessageModal" class="custom-modal">
      <div class="custom-modal-header">
          <button class="close-btn" id="closeViewMessageModalBtn"></button>
          <h5>View Message</h5>
      </div>
      <div class="custom-modal-body">
          <div id="viewMessageContent">
              <!-- Message content will be loaded here dynamically -->
          </div>
      </div>
  </div>
  <div id="viewMessageModalBackdrop" class="custom-modal-backdrop"></div>
  
  <!-- Custom Modal Script -->
  <script>
    // Open Send Message Modal
    document.getElementById('openSendMessageModalBtn').addEventListener('click', function () {
      document.getElementById('sendMessageModal').classList.add('show');
      document.getElementById('sendMessageModalBackdrop').classList.add('show');
    });

    document.getElementById('closeSendMessageModalBtn').addEventListener('click', function () {
      document.getElementById('sendMessageModal').classList.remove('show');
      document.getElementById('sendMessageModalBackdrop').classList.remove('show');
    });

    // Open View Message Modal
    document.querySelectorAll('.viewMessageLink').forEach(function(element) {
      element.addEventListener('click', function (event) {
        event.preventDefault();
        const messageId = this.getAttribute('data-id');
        fetchMessageContent(messageId);
      });
    });

    document.getElementById('closeViewMessageModalBtn').addEventListener('click', function () {
      document.getElementById('viewMessageModal').classList.remove('show');
      document.getElementById('viewMessageModalBackdrop').classList.remove('show');
    });

    function fetchMessageContent(messageId) {
      fetch(`/message/${messageId}/`)
        .then(response => response.text())
        .then(data => {
          document.getElementById('viewMessageContent').innerHTML = data;
          document.getElementById('viewMessageModal').classList.add('show');
          document.getElementById('viewMessageModalBackdrop').classList.add('show');
        });
    }
  </script>
{% endblock %}
