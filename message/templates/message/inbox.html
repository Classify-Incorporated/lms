{% extends 'base.html' %}
{% load static %}
{% block title %}
  Inbox
{% endblock %}
{% block content %}
  <h1 class="h3 mb-2 text-gray-800">Inbox</h1>

  <div class="row">
    <div class="col-md-2">
      <button class="btn btn-primary mb-3 w-100" id="openSendMessageModalBtn">Send Message</button>
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          Inbox
          <span class="badge badge-primary badge-pill" id="unreadCountBadge">0</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action">Sent</a>
        <a href="#" class="list-group-item list-group-item-action">Drafts</a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          Junk
          <span class="badge badge-warning badge-pill">65</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action">Trash</a>
      </div>
    </div>
    <div class="col-md-10">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Inbox</h5>
          <input type="text" id="searchMail" class="form-control w-25" placeholder="Search Mail" />
        </div>
        <div class="card-body p-0">
          <table class="table table-hover">
            <thead class="text-center">
              <tr>
                <th scope="col">
                  <input type="checkbox" id="selectAll" />
                </th>
                <th scope="col">Subject</th>
                <th scope="col">From</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody id="messageTable" class="text-center">
              {% if message_status_list %}
                {% for item in message_status_list %}
                  <tr class="message-row" data-id="{{ item.message.id }}">
                    <td>
                      <input type="checkbox" class="selectItem" />
                    </td>
                    <td>
                      <a href="#" class="text-decoration-none text-dark viewMessageLink" data-id="{{ item.message.id }}">{{ item.message.subject }}</a>
                    </td>
                    <td>{{ item.message.sender }}</td>
                    <td>
                      <span class="badge {% if item.read %}
                          
                          
                          
                          
                          
                          badge-success





                        {% else %}
                          
                          
                          
                          
                          
                          badge-warning





                        {% endif %}">
                        {% if item.read %}
                          Read
                        {% else %}
                          Unread
                        {% endif %}
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4">No matching records found</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <!-- Card Footer -->
        <div class="card-footer d-flex justify-content-between align-items-center">
          <div>
            <button class="btn btn-secondary"><i class="fas fa-arrow-left"></i></button>
            <button class="btn btn-secondary"><i class="fas fa-arrow-right"></i></button>
          </div>
          <div>
            <span>Showing {{ message_status_list|length }} messages</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Include the modals -->
  {% include 'message/message.html' %}

  <!-- View Message Modal -->
  <div id="viewMessageModal" class="custom-modal">
    <div class="custom-modal-header">
      <button class="close-btn" id="closeViewMessageModalBtn"></button>
      <h5>View Message</h5>
    </div>
    <div class="custom-modal-body">
      <div id="viewMessageContent">
        <!-- Message content will be loaded here dynamically -->
      </div>
    </div>
  </div>
  <div id="viewMessageModalBackdrop" class="custom-modal-backdrop"></div>

  <!-- Send Message Modal -->
  <div id="sendMessageModal" class="custom-modal">
    <div class="custom-modal-header">
      <button class="close-btn" id="closeSendMessageModalBtn"></button>
      <h5>Send Message</h5>
    </div>
    <div class="custom-modal-body">
      <!-- Send message form content -->
      <form id="sendMessageForm" method="post" action="{% url 'send_message' %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="recipient_type">To:</label>
          <select class="form-control" id="recipient_type" name="recipient_type" required>
            <option value="" disabled selected>Select Recipient</option>
            <optgroup label="Courses">
              {% for course in courses %}
                <option value="course_{{ course.id }}">{{ course.course_name }}</option>
              {% endfor %}
            </optgroup>
            <optgroup label="Subjects">
              {% for subject in subjects %}
                <option value="subject_{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </optgroup>
            <optgroup label="Instructors">
              {% for instructor in instructors %}
                <option value="teacher_{{ instructor.id }}">{{ instructor.username }}</option>
              {% endfor %}
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="subject">Subject:</label>
          <input type="text" class="form-control" id="subject" name="subject" required />
        </div>
        <div class="form-group">
          <label for="body">Message:</label>
          <textarea class="form-control" id="body" name="body" rows="5" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>
  </div>
  <div id="sendMessageModalBackdrop" class="custom-modal-backdrop"></div>

  <!-- Custom Modal Script -->
  <script>
    // Function to update unread messages count
    function updateUnreadCount() {
      const unreadCount = document.querySelectorAll('.message-row .badge-warning').length
      document.getElementById('unreadCountBadge').textContent = unreadCount
    }
    
    // Open Send Message Modal
    document.getElementById('openSendMessageModalBtn').addEventListener('click', function () {
      document.getElementById('sendMessageModal').classList.add('show')
      document.getElementById('sendMessageModalBackdrop').classList.add('show')
    })
    
    document.getElementById('closeSendMessageModalBtn').addEventListener('click', function () {
      document.getElementById('sendMessageModal').classList.remove('show')
      document.getElementById('sendMessageModalBackdrop').classList.remove('show')
    })
    
    // Open View Message Modal
    document.querySelectorAll('.viewMessageLink').forEach(function (element) {
      element.addEventListener('click', function (event) {
        event.preventDefault()
        const messageId = this.getAttribute('data-id')
        fetchMessageContent(messageId)
      })
    })
    
    document.getElementById('closeViewMessageModalBtn').addEventListener('click', function () {
      document.getElementById('viewMessageModal').classList.remove('show')
      document.getElementById('viewMessageModalBackdrop').classList.remove('show')
    })
    
    function fetchMessageContent(messageId) {
      fetch(`/message/${messageId}/`)
        .then((response) => response.text())
        .then((data) => {
          document.getElementById('viewMessageContent').innerHTML = data
          document.getElementById('viewMessageModal').classList.add('show')
          document.getElementById('viewMessageModalBackdrop').classList.add('show')
          updateUnreadCount() // Update unread count after fetching message content
        })
    }
    
    // Click row to view message
    document.querySelectorAll('.message-row').forEach(function (row) {
      row.addEventListener('click', function (event) {
        if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'A') {
          const messageId = this.getAttribute('data-id')
          fetchMessageContent(messageId)
        }
      })
    })
    
    // Select all checkboxes
    document.getElementById('selectAll').addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('.selectItem')
      checkboxes.forEach(function (checkbox) {
        checkbox.checked = document.getElementById('selectAll').checked
      })
    })
    
    function filterMessages() {
      const searchValue = document.getElementById('searchMail').value.toLowerCase()
      const rows = document.querySelectorAll('#messageTable .message-row')
      let hasVisibleRow = false
    
      // Remove any existing "No matching records found" row
      const existingNoRecordsRow = document.querySelector('#messageTable .no-records')
      if (existingNoRecordsRow) {
        existingNoRecordsRow.remove()
      }
    
      rows.forEach((row) => {
        const subject = row.querySelector('td:nth-child(2) a').textContent.toLowerCase()
        const sender = row.querySelector('td:nth-child(3)').textContent.toLowerCase()
    
        if (subject.includes(searchValue) || sender.includes(searchValue)) {
          row.style.display = ''
          hasVisibleRow = true
        } else {
          row.style.display = 'none'
        }
      })
    
      // Add "No matching records found" row if no rows are visible
      if (!hasVisibleRow) {
        const noRecordsRow = document.createElement('tr')
        noRecordsRow.className = 'no-records' // Add a class for identification
        noRecordsRow.innerHTML = '<td colspan="4">No matching records found</td>'
        document.querySelector('#messageTable').appendChild(noRecordsRow)
      }
    }
    
    // Event listener for search input
    document.getElementById('searchMail').addEventListener('input', filterMessages)
  </script>
{% endblock %}
