{% extends 'base.html' %}
{% load static %}
{% block title %}
  Inbox
{% endblock %}
{% block content %}
<h1 class="h3 mb-2 text-gray-800">Inbox</h1>

  <div class="row">
    <div class="col-md-2">
      <button class="btn btn-primary mb-3 w-100" id="openSendMessageModalBtn">Send Message</button>
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          Inbox
          <span class="badge badge-primary badge-pill">12</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action">Sent</a>
        <a href="#" class="list-group-item list-group-item-action">Drafts</a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          Junk
          <span class="badge badge-warning badge-pill">65</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action">Trash</a>
      </div>
    </div>
    <div class="col-md-10">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Inbox</h5>
          <input type="text" class="form-control w-25" placeholder="Search Mail">
        </div>
        <div class="card-body p-0">
          <table class="table table-hover">
            <thead class="text-center">
              <tr>
                <th scope="col"> <input type="checkbox"></th>
                <th scope="col">Subject</th>
                <th scope="col">From</th>               
              </tr>
            </thead>
            <tbody class="text-center">
              {% for item in message_status_list %}
              <tr>
                <td><input type="checkbox"></td>
                <td>
                  <a href="#" class="text-decoration-none text-dark viewMessageLink" data-id="{{ item.message.id }}">
                    {{ item.message.subject }}
                  </a>
                </td>
                <td>
                  {{ item.message.sender }}
                </td>
                <td>{{ item.message.date }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


<!-- Include the modals -->
{% include 'message/message.html' %}

<!-- View Message Modal -->
<div id="viewMessageModal" class="custom-modal">
  <div class="custom-modal-header">
    <button class="close-btn" id="closeViewMessageModalBtn"></button>
    <h5>View Message</h5>
  </div>
  <div class="custom-modal-body">
    <div id="viewMessageContent">
      <!-- Message content will be loaded here dynamically -->
    </div>
  </div>
</div>
<div id="viewMessageModalBackdrop" class="custom-modal-backdrop"></div>

<!-- Send Message Modal -->
<div id="sendMessageModal" class="custom-modal">
  <div class="custom-modal-header">
    <button class="close-btn" id="closeSendMessageModalBtn"></button>
    <h5>Send Message</h5>
  </div>
  <div class="custom-modal-body">
    <!-- Send message form content -->
    <form id="sendMessageForm" method="post" action="{% url 'send_message' %}">
      {% csrf_token %}
      <div class="form-group">
        <label for="recipient">To:</label>
        <input type="text" class="form-control" id="recipient" name="recipient" required>
      </div>
      <div class="form-group">
        <label for="subject">Subject:</label>
        <input type="text" class="form-control" id="subject" name="subject" required>
      </div>
      <div class="form-group">
        <label for="message">Message:</label>
        <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>
</div>
<div id="sendMessageModalBackdrop" class="custom-modal-backdrop"></div>

<!-- Custom Modal Script -->
<script>
  // Open Send Message Modal
  document.getElementById('openSendMessageModalBtn').addEventListener('click', function () {
    document.getElementById('sendMessageModal').classList.add('show');
    document.getElementById('sendMessageModalBackdrop').classList.add('show');
  });

  document.getElementById('closeSendMessageModalBtn').addEventListener('click', function () {
    document.getElementById('sendMessageModal').classList.remove('show');
    document.getElementById('sendMessageModalBackdrop').classList.remove('show');
  });

  // Open View Message Modal
  document.querySelectorAll('.viewMessageLink').forEach(function(element) {
    element.addEventListener('click', function (event) {
      event.preventDefault();
      const messageId = this.getAttribute('data-id');
      fetchMessageContent(messageId);
    });
  });

  document.getElementById('closeViewMessageModalBtn').addEventListener('click', function () {
    document.getElementById('viewMessageModal').classList.remove('show');
    document.getElementById('viewMessageModalBackdrop').classList.remove('show');
  });

  function fetchMessageContent(messageId) {
    fetch(`/message/${messageId}/`)
      .then(response => response.text())
      .then(data => {
        document.getElementById('viewMessageContent').innerHTML = data;
        document.getElementById('viewMessageModal').classList.add('show');
        document.getElementById('viewMessageModalBackdrop').classList.add('show');
      });
  }
</script>
{% endblock %}
