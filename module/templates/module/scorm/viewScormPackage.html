{% extends 'base.html' %}

{% block title %}
  View {{ scorm_package.file_name }}
{% endblock %}

{% block content %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

  <div class="container" style="padding-top: 20px;">
    <h1>{{ scorm_package.file_name }}</h1>

    {% if is_pdf %}
      <div id="pdf-container" style="min-height: 500px;">
        <canvas id="pdf-canvas" style="width: 100%;"></canvas>
      </div>
      <div class="text-right mt-2">
        <button id="prev-page" class="btn btn-secondary">Previous</button>
        <button id="next-page" class="btn btn-secondary">Next</button>
        <span>Page: <span id="page-num"></span> / <span id="page-count"></span></span>
      </div>
    {% endif %}

    {% if is_image %}
      <div>
        <img src="{{ scorm_package.file.url }}" class="img-fluid" alt="Image" style="width: 100%;" />
      </div>
    {% endif %}

    {% if is_video %}
      <div>
        <video controls style="width: 100%;">
          <source src="{{ scorm_package.file.url }}" type="video/mp4" />Your browser does not support the video tag.
        </video>
      </div>
    {% endif %}

    {% if is_unknown %}
      <p>Unsupported file format. Unable to display the content.</p>
    {% endif %}

    <div class="text-right mt-3">
      <a href="{% url 'subjectDetail' scorm_package.subject.id %}" class="btn btn-secondary">Back</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var url = '{{ scorm_package.file.url }}'
      var pdfDoc = null
      var pageNum = 1
      var canvas = document.getElementById('pdf-canvas')
      var ctx = canvas.getContext('2d')
    
      function renderPage(num) {
        pdfDoc.getPage(num).then(function (page) {
          var viewport = page.getViewport({ scale: 1.5 })
          canvas.height = viewport.height
          canvas.width = viewport.width
    
          var renderContext = {
            canvasContext: ctx,
            viewport: viewport
          }
    
          page.render(renderContext)
        })
    
        document.getElementById('page-num').textContent = num
      }
    
      pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
        pdfDoc = pdfDoc_
        document.getElementById('page-count').textContent = pdfDoc.numPages
        renderPage(pageNum)
      })
    
      document.getElementById('prev-page').addEventListener('click', function () {
        if (pageNum <= 1) {
          return
        }
        pageNum--
        renderPage(pageNum)
      })
    
      document.getElementById('next-page').addEventListener('click', function () {
        if (pageNum >= pdfDoc.numPages) {
          return
        }
        pageNum++
        renderPage(pageNum)
      })
    })
  </script>
{% endblock %}
